<?xml version="1.0" encoding="utf-16"?>
<DesiredConfigurationDigest xmlns="http://schemas.microsoft.com/SystemsCenterConfigurationManager/2009/07/10/DesiredConfiguration">
  <!--Authored against the following schema version: 5-->
  <OperatingSystem AuthoringScopeId="ScopeId_1CB14F9C-DC4C-4347-8A8F-161F814912B7" LogicalName="OperatingSystem_7f46dd98-fe8c-493c-b948-15eb92557262" Version="1">
    <Annotation xmlns="http://schemas.microsoft.com/SystemsCenterConfigurationManager/2009/06/14/Rules">
      <DisplayName Text="CI - Registry - Get PackageID Execution _State" ResourceId="ID-a68a63ee-53b7-4115-9842-7ebf56e745e2" />
      <Description Text="Check the exection state of an deploy PackgeID" ResourceId="ID-5e745bc6-cdb4-452b-90d4-b9969cce0eb4" />
    </Annotation>
    <Parts>
      <SuppressionReferences />
    </Parts>
    <Settings>
      <RootComplexSetting>
        <SimpleSetting LogicalName="ScriptSetting_e5dc9745-7a42-4340-94d5-3d0e357aa8a8" DataType="String">
          <Annotation xmlns="http://schemas.microsoft.com/SystemsCenterConfigurationManager/2009/06/14/Rules">
            <DisplayName Text="PS - Check PkgID Execution _State" ResourceId="ID-78cfa109-5003-4c1b-aea6-56e84e4447ae" />
            <Description Text="PS script to check the value &quot;_State&quot; and Data of the PackageID\ExecutionHistory-Key" ResourceId="ID-19abea4f-8c3e-4387-a6dd-40c1eb824a26" />
          </Annotation>
          <ScriptDiscoverySource Is64Bit="true">
            <DiscoveryScriptBody ScriptType="PowerShell">param(
  [string]$PackageID = "PS10000B"
)

#Get PackgeID execution history Registry key
$ExecutionHistoryKey = "HKLM:\SOFTWARE\Microsoft\SMS\Mobile Client\Software Distribution\Execution History\System\$PackageID"

#Determine SubKey to get Values
$ExecutionHistorySubKey = Get-ChildItem $ExecutionHistoryKey | Select -ExpandProperty Name
$PackageExecutionHistoryKey = $ExecutionhistorySubKey -Replace "HKEY_LOCAL_MACHINE","HKLM:"

#Get the execution state from "_State" value data 
$_State = (Get-ItemProperty $PackageExecutionHistoryKey)._State
Write-Output $_State</DiscoveryScriptBody>
          </ScriptDiscoverySource>
        </SimpleSetting>
      </RootComplexSetting>
    </Settings>
    <Rules>
      <Rule xmlns="http://schemas.microsoft.com/SystemsCenterConfigurationManager/2009/06/14/Rules" id="Rule_a6e442f3-101c-459d-8d5e-95438352e018" Severity="Informational" NonCompliantWhenSettingIsNotFound="true">
        <Annotation>
          <DisplayName Text="Execution _State = Success" ResourceId="ID-30e4f7e1-b13e-4977-8d86-1669113c899d" />
          <Description Text="Check that the value &quot;_State&quot; data equals &quot;Success&quot;" ResourceId="ID-4043385b-e3eb-4d6d-990a-7e2b7e0ee095" />
        </Annotation>
        <Expression>
          <Operator>Equals</Operator>
          <Operands>
            <SettingReference AuthoringScopeId="ScopeId_1CB14F9C-DC4C-4347-8A8F-161F814912B7" LogicalName="OperatingSystem_7f46dd98-fe8c-493c-b948-15eb92557262" Version="1" DataType="String" SettingLogicalName="ScriptSetting_e5dc9745-7a42-4340-94d5-3d0e357aa8a8" SettingSourceType="Script" Method="Value" Changeable="false" />
            <ConstantValue Value="Success" DataType="String" />
          </Operands>
        </Expression>
      </Rule>
    </Rules>
    <OperatingSystemDiscoveryRule xmlns="http://schemas.microsoft.com/SystemsCenterConfigurationManager/2009/06/14/Rules">
      <OperatingSystemExpression>
        <Operator>OneOf</Operator>
        <Operands>
          <RuleExpression RuleId="Windows/All_Windows_Client_Server" />
        </Operands>
      </OperatingSystemExpression>
    </OperatingSystemDiscoveryRule>
  </OperatingSystem>
</DesiredConfigurationDigest>